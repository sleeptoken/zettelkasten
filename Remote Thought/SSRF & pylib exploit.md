
2024-08-09 15:51

Source: #htb #CTF #privesc 

Tags: [[linux]]
### Reconnaissance 

1. we got a machine with port 22 - SSH and 80 - HTTP open
2. the website at the IP has a `upload` page - we find this by running gobuster 
3. the upload page for a book that allows us to upload a file of our choice (intended to be an image) and then preview that file. the page also allows us to upload a cover URL for our book.
### Enumeration (Trying)

1. on uploading a PHP revshell, click on the image and open in new tab, the file name renamed and the file extension is removed, further the file downloads directly so we can't execute a shell directly.
2. Next, let’s upload a valid image file and download the previewed file. We can see if the file using any software like `ImageMagick` by using `exiftool`.
### SSRF VULNERABILITY

1. The interesting part is the URL preview, this feature might be vulnerable to SSRF.
2. Insert local address(127.0.0.1) in the URL field. intercept the request on [[burpsuite]] - The response is showing a image directory location.
3. This machine might have another port running locally, we can brute force the port by using burp intruder, and add a port number from 1–65535.
4. we find that port 5000 has a different result 
5. input the URL as `http://127.0.0.1:5000` we get an extra response which contains a separate upload path 
6. when opening the request with that path in it , we see a message .
7. the message contains different [[API]] endpoints and their descriptions.
8. input the URL as `http://127.0.0.1:5000/api/latest/metadata/messages/authors`. Above appended endpoint was found in the message . 
##### TLDR
we have a input field named book URL, this field has a [[SSRF]] vulnerability.
when entering local address with port 5000 we are able to access some resources i.e. we tell the server to hit API's on our behalf. The resources that we get from the server has login creds for a user named dev. 
### SSH as dev -> prod

- we have a hidden directory named [[git]]
 **do not open the .git folder and run the commands** 
- run git commands from outside the .git directory or `This operation must be run in a work tree` error pops up \

```
git log               -> to see the commits
git show commit_id    -> to view a particular commit 
```
we find a message in the commit that has creds to the user named `prod`
### Privilege Escalation 

user prod has a [[sudo]] privilege.  `sudo -l` 

```
(root) /usr/bin/python3 /opt/internal_apps/clone_changes/clone_prod_change.py *
```
- the code for `/clone_prod_change.py` uses a git library to perform clone operation.
- When analyzing the code files and the packages using the command **pip3 list**, found that 1 package that was vulnerable. It was **_GitPython 3.1.29_** which was affected by a RCE Vulnerability lists as [CVE-2022–24439](https://github.com/gitpython-developers/GitPython/issues/1515).

```shell
sudo /usr/bin/python3 /opt/internal_apps/clone_changes/clone_prod_change.py 'ext::sh -c cat% /root/root.txt% >% /tmp/root'

cat /tmp/root
```
### References
https://app.hackthebox.com/machines/Editorial

walkthrough 
https://www.youtube.com/watch?v=jUJNxdOHHzQ

[Hack The Box | Season 5-Editorial Writeup | by Luc1f3r | Jun, 2024 | Medium](https://medium.com/@nkrohitkumar2002/hack-the-box-season-5-editorial-writeup-552635f389d6)
[Editorial | editorial writeup htb | hackthebox | htb editorial writeup | editorial htb | Medium](https://medium.com/@kryntol6/editorial-htb-writeup-9610307c54ef)